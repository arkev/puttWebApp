extends layout

block content
  .home
    .header
      .left
        img.brand(src="/images/PuttLab2.svg" alt="PuttLab")
      .right
        if user && user.avatarUrl
          a(href="/you" aria-label="Ir a Tú")
            img.avatar(src=user.avatarUrl alt="avatar")
      .saludo
        .greet Hola, #{(user && user.name) ? user.name : 'Jugador'}
        .subtle Tu práctica te espera

    .hero
      .cta-card
        .top
          .title Reanudar última rutina
          if lastRoutine
            .meta #{lastRoutine.name} · #{lastRoutine.stations.length} estaciones
          else
            .meta Aún no tienes rutinas
        if lastRoutine
          .stations
            each d in lastRoutine.stations
              .badge #{d} m
          a.btn-primary(href=`/routines/${lastRoutine.id}/start`)
            i.fa-solid.fa-play
            |  Iniciar
        else
          a.btn-primary(href="/routines/new")
            i.fa-solid.fa-plus
            |  Crear rutina

    .kpis
      .kpi
        .label C1 %
        .donut(style=`--p:${(kpis && typeof kpis.c1 !== 'undefined') ? kpis.c1 : 0}; --donut-color:#18b2c3;`)
          span.donut-value #{(kpis && typeof kpis.c1 !== 'undefined') ? kpis.c1 : 0}%
      .kpi
        .label C2 %
        .donut(style=`--p:${(kpis && typeof kpis.c2 !== 'undefined') ? kpis.c2 : 0}; --donut-color:#18b2c3;`)
          span.donut-value #{(kpis && typeof kpis.c2 !== 'undefined') ? kpis.c2 : 0}%
      .kpi
        .label Sesiones
        .value.sessions-count #{(kpis && typeof kpis.sessionsCount !== 'undefined') ? kpis.sessionsCount : 0}

    .section
      .section-header
        .h2 Últimas sesiones
        a.see-all(href='/sessions') Ver todas
      if Array.isArray(sessions) && sessions.length
        .list
          each s in sessions
            - const totalA = (s.stations||[]).reduce((a,x)=>a+(x.attempts||0),0)
            - const totalH = (s.stations||[]).reduce((a,x)=>a+(x.hits||0),0)
            - const p = totalA ? Math.round((totalH/totalA)*100) : 0
            .item
              .left
                .title= new Date(s.date).toLocaleDateString()
                .meta= s.routineName ? s.routineName : (s.routineId ? 'Rutina' : (s.challengeId ? 'Challenge' : 'Sesión'))
              .right
                .pill #{p}%
      else
        .empty No hay sesiones todavía.

    // Modal: Añadir a pantalla de inicio
    .modal-overlay#installModal(aria-hidden="true")
      .modal(role="dialog" aria-modal="true" aria-labelledby="installTitle")
        button.modal-close(type="button" aria-label="Cerrar")
          i.fa-solid.fa-xmark
        .modal-hero
          img(src="/images/ejemplo-inicio.jpg" alt="Ejemplo añadir a pantalla de inicio")
        .modal-body
          h2#installTitle ¡Guarda un acceso directo a PuttLab en tu pantalla de inicio para acceder rápidamente!
          p
            | Toca 
            i.fa-solid.fa-share-from-square
            |  en la barra de herramientas
          p
            | Selecciona Añadir a la pantalla de inicio 
            i.fa-solid.fa-square-plus

    // Barra inferior
    .bottom-nav
      a.nav-item(class=activeTab==='home' ? 'active' : '', href="/")
        i.fa-solid.fa-house
        span Inicio
      a.nav-item(class=activeTab==='discs' ? 'active' : '', href="/discs")
        i.fa-solid.fa-compact-disc
        span Discos
      a.play(href="/session" aria-label="Iniciar sesión")
        i.fa-solid.fa-bullseye
      a.nav-item(class=activeTab==='routines' ? 'active' : '', href="/routines")
        i.fa-solid.fa-list-check
        span Rutinas
      a.nav-item(class=activeTab==='you' ? 'active' : '', href="/you")
        i.fa-solid.fa-user
        span Tú
block scripts
  script.
    (function(){
      var key = 'plInstallModalClosed';
      var modal = document.getElementById('installModal');
      if(!modal) return;
      if(localStorage.getItem(key)==='1') return;
      // Mostrar modal
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      var btn = modal.querySelector('.modal-close');
      function close(){
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden','true');
        try{ localStorage.setItem(key,'1'); }catch(e){}
      }
      btn && btn.addEventListener('click', close);
      modal.addEventListener('click', function(e){ if(e.target===modal) close(); });
    })();
